%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Draft
% 
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[a4paper,10pt]{article}  %scrartcl
% \usepackage{preview}

\input{C:/Users/falves/Dropbox/TexFolder/preamble.tex} 
% \input{/Users/felipealves/Dropbox/TexFolder/preamble.tex}

%%% EXTRA Packages
\usepackage{upgreek}
\usepackage[ntheorem]{empheq}
\newcommand{\minus}[1]{{#1}^{-}}
\newcommand{\plus}[1]{{#1}^{+}}

%%%%%%%%%
\title{\textsc{User Guide 02} \\ State-Dependent Pricing \vspace{-1.25em}} % use 5
% {
%         \vspace{-0in}  
%         \usefont{OT1}{bch}{b}{n}
%         \normalfont \normalsize \
%         \horrule{0.5pt} \[0.0cm]
%         \huge Referee report on ``Learning, Confidence, and Business Cycles''  \[-0.5cm]
%         \horrule{2pt} \[-0.5cm]
% }
\author{
        \normalfont\large Felipe Alves \\[-2.5pt]       \normalsize
        \today
}
\date{ \vspace{-3em} }

% *************************************************************************************************************
% ************************************************                ********************************************* 
% *************************************************************************************************************

\begin{document}
\maketitle
\begin{abstract}
   These notes present a second example of Reiterâ€™s Projection+Perturbation approach to solve heterogenous agents models in the
   presence of aggregate uncertainty. For this application, we choose a \textbf{menu-cost model} in the spirit of \citet{GolosovLucas}.
   The model itself has been well studied in the literature - see \citet{midrigan} and \citet{Vavra} subsequent contributions - where
   it is usually solved using \citet{krusell_smith} method. To see an application of the same methods to a similar menu-cost model as
   the one discussed in these notes, check \citet{reiterstudent}.
\end{abstract}
% %**************************************************************************************************************************
% %%%%%%% INTODUCTION
% %--------------------------------------------------------------------------------------------------------------------------
% \section{Intoduction} % (fold)
% \label{sec:intoduction}
% %%%
% \begin{itemize}
   
%    %%
%    \item Some comment

% \end{itemize}
%  %%%
% % SECTION INTODUCTION (END)
% %..........................................................................................................................

%**************************************************************************************************************
%%%%%%% MODEL
%--------------------------------------------------------------------------------------------------------------
\section{Model} % (fold)
\label{sec:model}

%%%%%%% Household  
%--------------------------------------------------------------------------------------------------------------------------
\subsection{Household} % (fold)
\label{sub:household}

There is a representative household with utility function
%%%
\begin{equation}
   \label{eq:utility}
   E_0 \sum_{t=1}^{\infty} \beta^t \bigg[ \frac{ C_t^{1-\sigma} -1}{ 1-\sigma } - \chi \frac{ N_t^{1+ 1/\varphi} }{ 1+ 1/\varphi } \bigg]   
\end{equation}
%%%
Consumption is a CES aggregate of differentiated goods $\{ c_t(h): h \in[ 0,1 ] \}$, with elasticity of substitution $ \epsilon $
\[
   C_t = \left( \int c_t(h)^{ \frac{\epsilon-1}{\epsilon} }  \right)^{\frac{\epsilon}{ \epsilon -1 }  }
\] 
Optimal allocation across the differentiated goods implies the following demand function
%%%
\begin{equation}
   \label{eq:demand_cons}
   c_t(h) = \big(p_t(h)/P_t \big)^{- \epsilon} C_t 
\end{equation}
%%%
where $ P_t $ is the price index defined by
%%%
\begin{equation}
   \label{eq:price_index}
   P_t \equiv \left( \int p_t(h)^{1-\epsilon} \right)^{ \frac{1}{1-\epsilon} } 
\end{equation}
%%%
Household's nominal period budget constraint is 
\[
   \underbrace{\int p_t(h) c_t(h)dh}_{P_t C_t} + R_t^{-1} B_t= w_t N_t + B_{t-1}+T_t
\]
where $ B_{t} $ is the nominal bond holdings purchased at $t$ with nominal return of $ R_t $ between $ t\mapsto t+1 $ and $ T_t $ are the
nominal dividend payments from the firms. Hence, households choose $ \big\{ C_t, N_t, B_t\big\} $ to maximize \eqref{eq:utility}
subject to household's nominal period budget constraint. Optimality requires the following conditions
%%%
\begin{align}
   % \label{eq:problem}
   N^{1/\varphi} & = \frac{1}{\chi} C^{-\sigma} w_t  \\
   R_{t}^{-1}    & = \beta E_t \Bigg\{ \left(\frac{C_{t+1}}{C_{t}}\right)^{-\sigma} \frac{P_t}{ P_{t+1} } \Bigg\} \\
   D_{t,t+\tau}  & =  \beta \left(\frac{C_{t+\tau}}{C_{t}}\right)^{-\sigma} \frac{P_t}{ P_{t+\tau} }
\end{align}
%%%

% Subsection household (end)
%..........................................................................................................................

%%%%%%% Firms  
%--------------------------------------------------------------------------------------------------------------------------
\subsection{Firms} % (fold)
\label{sub:firms}

% %%%
% \begin{itemize}[label=\raisebox{0.50ex}{\tiny$\bullet$}]
%% 
% \item 
Each firm $h$ produces output $y_t(h)$ with labor $\ell_t(h)$ as the only input and is subject to an aggregate
and an idiosyncratic productivity $ Z_t,a_t(h) $
%%%
\begin{equation}
   \label{eq:model_eq1}
   y_t(h) = Z_t a_t(h) \ell_t(h)
\end{equation}
%%%
%% 
% \item 
Firms act as monopolistic competitors and choose their prices to maximize its market value
%%%
\begin{equation}
   \label{eq:model_eq}
   \mathbb{E}_t \sum_{\tau=0}^{\infty} D_{t,t+\tau} \Pi_{t+\tau} (h)
\end{equation}
%%%
where $D_{t,t+\tau}$ is the nominal stochastic discount factor of the household introduced below and $\Pi_{t+\tau}
(h) $ are the nominal profits in period $ t $. The firm can change its price only upon payment of fixed cost $ \xi
\in \big[ 0, \bar{\xi} \big] $ denoted in units of labor. Specifically, each period a firm draws a cost from the
time-invariant distribution $ H $ and decides whether or not to change its price. Given these restrictions, firm's
flow profits are given by
%%%
\begin{equation}
   \label{eq:model_eq3}
   \Pi_t(h) = p_t(h) y_t(h) - W_t \ell_t(h) - \xi_t(h) W_t \mathbbm{1} \big\{p_t(h) \ne p_{t-1}(h) \big\}
\end{equation}
%%%
The firm understands that its sales $ y_t(h) $ depend upon the price charged for the good according to \eqref{eq:demand_cons}. 
% \end{itemize}
% %%%

%%%%%%%%%%
\paragraph{Recuvisve Formulation.} % (fold)
\label{par:recuvisve_formulation}
%% Value Function   
We start by expressing everything in real terms, since the nominal price level should be irrelevant for 
the equilibrium. Define the real profit function in terms of idiosyncratic productivity and relative prices by
incorporating the demand function \eqref{eq:demand_cons}
%%%
\begin{equation}
   \label{eq:profit_function}
   \Pi^R_t (a, \tilde{p}) = C_t \tilde{p}^{-\epsilon} \left( \tilde{p} - \frac{w_t}{Z_t a}\right)
\end{equation}
%%%
We can write the problem recursively as
\begin{multline}
   V_t \left( a_t(h), \frac{ p_{t-1}(h) }{ P_t }, \xi_t;  \bsy{s}  \right) = 
   \max_{p} 
   \Bigg\{
      \Pi^R_t \left( a_t(h), \frac{ p }{ P_t } \right) 
      -\mathbbm{1} \big\{ p \ne p_{t-1}(h ) \big\} \xi_t  w_t + \\
      %%
      + \mathbb{E}_t \bigg[ D^R_{t,t+1} V_{t+1} \left( a_{t+1}(h), \frac{ p }{ P_{t+1} }, \xi_{t+1}, \bsy{s} \right) \bigg] \Bigg\}
\end{multline}
where $\bsy{s}$ is the aggregate state vector - see Subsection \ref{sub:equilibrium} for a discussion of what is a sufficient aggregate
state for this economy.
% \begin{multline}
%    V_t \left( a, \frac{ p_{-1}(h) }{ P }, \xi; \ \cdot \ \right) = 
%    \max_{p} 
%    \Bigg\{
%       \Pi^R \left( a, \frac{ p_{-1} }{ P }, \cdot \right) 
%       -\mathbbm{1} \{p \ne p_{-1} \} \xi + \\
%       %%
%       + \mathbb{E}_t \bigg[ D^R_{t,t+1} V_{t+1} \left( a_{t+1}(h), \frac{ p }{ P_{t+1} }, \xi_{t+1}, \cdot \right) \bigg] \Bigg\}
% \end{multline}
It is computationally convenient to rewrite the problem in terms of two value functions $ \big\{V^A,V^N \big\} $, which denote
respectively the value of adjusting and not adjusting. Moreover, we can get rid of $ \xi $ as a state variable by defining beginning-
of-period expected value of a firm \emph{prior} to its fixed cost draw, but after the determination of idiosyncratic productivity and
aggregate state
%%%
\begin{equation}
   \label{eq:value_fnc01}
   v \big(a, x;  \bsy{s}  \big) \defeq \int_{\xi} \max \Big\{ V^A(a,x;  \bsy{s}  ) - \xi w(\bsy{s}) , \ V^N(a,x ;  \bsy{s}  )  \Big\} dH(\xi )
\end{equation}
%%% 
where
%%%
\begin{align}
   \label{eq:value_fnc02}
   V^A\big(a;  \bsy{s}  \big) & = \max_{\tilde{p}} 
      \Bigg\{ 
         \Pi^R \left( a, \tilde{p}, \bsy{s} \right) + 
         \mathbb{E} \bigg[ D^R(\bsy{s},\bsy{s}) v\left( a, \frac{ \tilde{p} }{ \uppi(\bsy{s}') } ; \ \bsy{s}' \ \right) \bigg]
      \Bigg\} \\
   %%
   \label{eq:value_fnc03}
   V^N\big(a, x;  \bsy{s}  \big) & = 
       \Pi^R \left( a, x; \bsy{s} \right) + \mathbb{E}
       \left[ 
            D^R(\bsy{s},\bsy{s}) v\left( a', \frac{x}{ \uppi(\bsy{s}') } ; \ \bsy{s}' \  \right)
       \right]
\end{align}
%%%
It is clear that a firm will choose to change its price only if the net value of doing so is at least as great as the
continuation under the relative price $ x $. Therefore, firms will follow a \textbf{threshold rule}. In particular, let 
$ \widetilde{\xi} (a,x) $ describe the fixed cost that leaves a type $ (a,x ) $ firm indifferent between
adjusting/not adjusting
%%%
\begin{equation}
   \label{eq:threshold_policy}
   V^a\big( a ; \bsy{s} \big) - w(\bsy{s})\widetilde{\xi}(a,x; \bsy{s} ) =  V^n\big( a,x; \bsy{s} \big)
\end{equation}
%%%
Thus, within each group of firms with idiosyncratic state $ (a,x) $, a fraction $ H\big( \widetilde{\xi}(a,x; \bsy{s} ) \big) $ chooses
to incur on the menu-cost and change their prices while a fraction $ H\big( \widetilde{\xi}(a,x; \bsy{s} ) \big) $ find it optimal not
to adjust their prices. Given this observation, the firm's value function $v$ in \eqref{eq:value_fnc01} can be expressed as
\begin{equation}
   v(a, x; \ \cdot \ ) = 
      \int_0^{ \tilde{\xi}(a,x ) } 
      \Big[ 
         V^A(a, x ; \ \cdot \ ) - \xi w(\cdot) 
      \Big]d\xi  
      + \Big[  1 - H\Big( \tilde{\xi}(a, x ; ) \Big) \Big] V^N(a,x ; \ \cdot \ )
\end{equation}

% paragraph recuvisve_formulation (end)

% Subsection firms (end)
%..........................................................................................................................


%%%%%%% Monetary Policy  
%--------------------------------------------------------------------------------------------------------------------------
\subsection{Monetary Policy} % (fold)
\label{sub:monetary_policy}

The monetary policy follows a Taylor interest rate rule
%%%
\begin{equation}
   \label{eq:Taylor_rule}
   \frac{R_t}{R^*} = \exp \big( \epsilon_t \big) \left( \frac{P_t/P_{t-1}}{ \uppi^* } \right)^{ \phi_{\pi} } \left( \frac{C_t}{C^*} \right)^{ \phi_{y} } 
\end{equation}
%%%
where $ \uppi^* $ is the inflation target at steady-state. For all the exercises, we will take it to be equal to 1. 
% Subsection monetary_policy (end)
%..........................................................................................................................

\newpage
\rule{\textwidth}{1pt}\\ \small
{\bf\color{OrangeRed} What about inflation equation?} \\
We are still missing an equilibrium equation for inflation. Consider the simple case where firm's do not differ on their
idiosyncratic productivity. For a given $ \epsilon $, the firms that would adjust price given inflation $ \uppi(\bsy{s} ) $
is given by
\[
   \mathcal{C}(\xi; \bsy{s} ) \defeq \bigg\{ \tilde{p}_{-} : \xi > \tilde{\xi} \left( \frac{\tilde{p}_{-}}{\uppi(\bsy{s})} \right) \bigg\}  
\]
From the definition of the price index in \eqref{eq:price_index} we have
%%%
\begin{align*}
   \uppi(\bsy{s})^{1-\epsilon} & = 
      \int_0^{ \overline{\xi} } \int 
      \bigg[ \uppi(\bsy{s}) \centerdot \tilde{p}\left( \frac{\tilde{p}_{-}}{ \uppi(\bsy{s})}, \xi; \bsy{s} \right) \bigg]^{1-\epsilon}
      d\tilde{\Psi}_{-} dH(\xi) \\
      & = \Big(p^* \uppi(\bsy{s} ) \Big)^{1- \epsilon} 
      \underbrace{\left( 
         \int_0^{\overline{\xi}} \int_{ \tilde{p}_{-} \not\in \mathcal{C}(\xi;\bsy{s} ) } d\widetilde{\Psi}_{-} dH(\xi)
      \right)}_{ \Omega(\bsy{s}) }
      + \int_0^{\overline{\xi}} \int_{\tilde{p}_{-} \in \mathcal{C}(\xi;\bsy{s} )} \tilde{p}_{-}^{1-\epsilon} d\widetilde{\Psi}_{-} dH(\xi)
\end{align*}
%%%
Rearranging 
\[
   \uppi(\bsy{s}) = 
   \left( \frac{1-\Omega(\bsy{s})}{ 1-\Omega(\bsy{s}) \big(p^*\big)^{1-\epsilon} } \right)^{\frac{1}{1-\epsilon}}
   \left( \frac{1}{1-\Omega(\bsy{s})} \int_0^{\overline{\xi}} \int_{\tilde{p}_{-} \in \mathcal{C}(\xi;\bsy{s} )} \tilde{p}_{-}^{1-\epsilon} d\widetilde{\Psi}_{-} dH(\xi) \right)^{\frac{1}{1-\epsilon}}
\]
in the simple Calvo model with probability of changing prices of $ \theta $ we would get
\[
   \uppi(\bsy{s}) = 
   \left( \frac{1-\theta}{ 1-\theta \big(p^*\big)^{1-\epsilon} } \right)^{\frac{1}{1-\epsilon}}
\]
In the computation, instead of working with this condition, we will be working on the equivalent restriction that 
real price of consumption aggregate is equal to 1 
\[
   1 = \int \tilde{p}^{1-\epsilon} d\tilde{\Psi}(\bsy{s})
\]
The apparently simpler relation uses the updated distribution $ \widetilde{\Psi} $, which already incorporates
the decision of firms to adjust or not their prices facing a inflation $ \uppi(\bsy{s}) $ \\
\rule{\textwidth}{1pt}
\normalsize

%%%%%%% Equilibrium  
%--------------------------------------------------------------------------------------------------------------------------
\subsection{Equilibrium} % (fold)
\label{sub:equilibrium}

%%%%%%%%%%
\paragraph{\normalfont\bf Aggregate state.} 
In the recursive competitive equilibrium, what described the aggregate state $ \bsy{s} $ of the economy is the realization of aggregate
shocks $ \uppsi =\big\{ Z, \epsilon \big\} $ and the distribution of last period production relative prices $ \widetilde{\Psi}_{-1} $.
To see why this state is sufficient, imagine there exists a map from it to inflation $ \uppi(\bsy{s} ) $. Given this map, we can
compute beginning of period - prior to adjustment decision - relative prices $\Psi$. Policy functions of the firm, which also depend on
maps $ C(\bsy{s} ), w(\bsy{s} )$ that come from household optimization and market clearing, imply then a mapping $ \Psi \rightarrow
\widetilde{\Psi} $. Note that \eqref{eq:price_index} constrains the distribution $ \widetilde{\Psi} $, which is what helps to pin down
inflation $\uppi(
\bsy{s})$ we started with\footnote{Check the above box for a tentative explanation regarding this}. It is my hope that the
implementation will make clearer.

\newpage
\begin{equil} \small
A recursive competitive equilibrium is a set of value functions $ \Big\{ v, V^A, V^{N} \Big\} $, policies $ \big\{
\tilde{p}, \tilde{\xi} \big\} $ for the firm, policies $ \Big\{ C(\bsy{s}), N(\bsy{s}) \Big\} $ for the household, wage $
w(\bsy{s}) $, interest rate $ R(\bsy{s}) $ and inflation $ \uppi(\bsy{s}) $, and a law of motion $\Gamma$ for the aggregate
state $ \bsy{s} \mapsto $
%%%
\begin{enumerate}
   
   %%
   \item \emph{(Firm optimization)} \\
   Taking $ \big\{ w(\bsy{s}),C(\bsy{s}),\uppi(\bsy{s}) \big\}$ as given the value function solves the Bellman equation in
   \eqref{eq:value_fnc01}-\eqref{eq:value_fnc03} and the $ \{ \tilde{p}, \xi \} $ are the associated policies

   %% 
   \item \emph{(Household optimization)} \\
   \[
      R(\bsy{s} )  \mathbb{E} \Bigg\{\beta \left( \frac{C(\bsy{s}')}{C(\bsy{s}} \right)^{-\sigma} \frac{ 1 }{ \uppi(\bsy{s}') } \Bigg\} = 1 , 
      \qquad
      N^{1/\varphi} = \frac{1}{\chi} C^{-\sigma}  w( \cdot )
   \]

   %% 
   \item \emph{(Market clearing)}
   %%%
   \begin{itemize}[leftmargin = 0.1in, label=\raisebox{0.5ex}{\tiny$\bullet$}] 
      \item Bonds market: $ B_t = 0 $ %{\color{RubineRed} Include this?}
      \item Labor market:
      %%%
      \begin{equation}
         \label{eq:labor_market}
         %%%
         \begin{split}
            % \left( \frac{1}{\chi} C^{-\sigma}  w \right)^{\varphi} & = 
            N & = 
            \int \int_0^{ \bar{\xi} }
            \Bigg[ 
               \ell \Big(a, \tilde{p}(a,x,\xi; \bsy{s} ) ; \bsy{s}\Big) + 
               \mathbbm{1} \Big\{ \tilde{p}(a,x,\xi; \bsy{s} ) \ne x \Big\} \xi
            \Bigg]
            dH( \xi ) \ d\Psi \\           
            % & = \int 
            % \Bigg[ 
            %       H\Big( \tilde{\xi}( a,x;\bsy{s} ) \Big) \ell\Big(a, \tilde{p}^a(a; \bsy{s} ) ; \bsy{s} \Big) + \\
            % & \qquad \qquad
            %       \left( 1- H\Big( \tilde{\xi}( a,x;\bsy{s} ) \Big) \right) \ell\Big(a, x ; \bsy{s} \Big) + 
            %       \int_0^{ \tilde{\xi}(a,x; \bsy{s} ) } \xi dH(\xi)
            % \Bigg] d\Psi \\
            & = \int \ell\big( a,\tilde{p}; \bsy{s} \big) \widetilde{\Psi}\big( d[a \times \tilde{p}] \big) + 
            \int_0^{ \overline{\xi} } \xi 
            \bigg[ 
               \underbrace{\int \mathbbm{1} \big\{ \xi \le \widetilde{\xi}( a,x;\bsy{s} ) \big\} \Psi\big(d[ a \times x ] \big) }_{ \Omega(\xi; \bsy{s} ) }
            \bigg]
            dH(\xi)
         \end{split}
      \end{equation}
      %%%
      where $ \ell(a,\tilde{p}; \bsy{s} ) = \frac{ \tilde{p}^{-\epsilon} Y }{ Z a } $. 

      %%
      \item Goods market:
      %%%
      \begin{equation}
         \label{eq:goods_market}
         %%%
         C_t = Y_t = \left( \int_0^1 y(h)^{ \frac{\epsilon-1}{\epsilon} } dh \right)^{ \frac{\epsilon}{\epsilon-1} } \\
      \end{equation}
      %%%

      %% consistency on prices 
      \item The distribution over real prices should satisfy the condition
      %%%
      \begin{equation}
         \label{eq:consistency_prices}
         1 = \left( \int \tilde{p}^{1-\epsilon} d\widetilde{\Psi} \right)
      \end{equation}
      %%%
      which reflects the fact the real price level is one by definition.
   \end{itemize}
   %%%

   %% 
   \item \emph{(Law of motion Distribution)}

   
   %% Law of motion
   \item \emph{(Law of motion for the aggregate shocks)}
\end{enumerate}
%%%
\end{equil} \normalsize

Using the functional form on the demand for labor note we can write the labor market clearing
%%%
\begin{equation}
   \label{eq:labor_market02}
   \begin{split}
      N(\bsy{s}) & = C(\bsy{s}) \int \frac{ \tilde{p}^{-\epsilon} }{Za} \widetilde{\Psi}\big( d[a \times \tilde{p}] \big) + 
             \int_0^{ \bar{\xi} } \xi \cdot \Omega(\xi; \bsy{s} ) dH(\xi) \\
      & = C(\bsy{s}) \int \frac{ \tilde{p}^{-\epsilon} }{Za} \widetilde{\Psi}\big( d[a \times \tilde{p}] \big) + \Omega(\bsy{s})
   \end{split}
\end{equation}
%%%

% Subsection equilibrium (end)
%............................................................................................................

% SECTION MODEL (END)
%............................................................................................................

\newpage 
%************************************************************************************************************
%%%%%%% METHOD
%------------------------------------------------------------------------------------------------------------
\section{Method} % (fold)
\label{sec:method}

Check the notes on the Krusell-Smith model.

%%%%%%% Finite Dimensional Approximation  
%--------------------------------------------------------------------------------------------------------------------------
\subsection{Finite Dimensional Approximation} % (fold)
\label{sub:finite_dimensional_approximation}

%%%%%%%%%%
\paragraph{Firm's Value Function} % (fold)
\label{par:firm_s_value_function}

%%%
\begin{itemize}[leftmargin=0in,label=\raisebox{0.50ex}{\tiny$\bullet$}]
   
   %% 
   \item Value functions are differently approximated in steady state and on the perturbation step. Here we discuss only the first,
   which relies on approximating the dependence on idiosyncratic states only%
   \footnote{Check the code for details on the approximation at the perturbation step. In short, we don't perturb the coefficients $
   \uptheta^* $ at steady state but instead the steady state value $ v(a_j,x_i; \bsy{\uptheta} ) $ at every node. }. Specifically, I
   approximate the value functions
   by
   %%%
   \begin{equation}
      \label{eq:approx_value_function}
      v\big( a, x ; \bsy{\uptheta} \big) \approx \sum_{j=1}^{n_a} \sum_{i=1}^{n_x} \uptheta_{j,i} \centerdot \psi_{j,i} (a,x)
   \end{equation}
   %%%
   where $ n_a, n_x $ denote the order of approximation for each dimension, $ \big\{ \psi_{i,j} \big\} $ the family of splines chosen
   and $ \uptheta_{j,i} $ are the coefficients on these polynomials.

   %%
   \item With this particular approximation of the value function, we solve for the steady state coefficients using \emph{collocation}
   which requires the functional equation for the value function to hold exactly on a set of grid points 
   $ \big\{a_j, x_i\big\}_{j=1,n_a \ i =1,n_x} $
   %%%
   \begin{align*}
      %%
      % \label{eq:_eq1}
      v \big( a_j, x_i; \bsy{\uptheta}^* \big) & = 
      H \Big( \tilde{\xi}(a_j,x_i) \Big) 
         \Bigg\{ 
               \Pi^R\Big( a_j, \tilde{p}^a (a_j) \Big) + \beta\sum_{a_{j'}\in \mathcal{A} } \Pi(a_j,a_{j'})
               v \left( a_{j'},\frac{\tilde{p}^a (a_j, x_i)}{\uppi^*} ; \ \bsy{\uptheta}^* \right) 
         \Bigg\} \  + \\
      %%
      % \label{eq:_eq2}
      & \qquad w^* \int_0^{ \tilde{\xi}(a_j,x_i) } \xi dH(\xi) \quad + \\
      & \qquad \left( 1- H\Big( \tilde{\xi}(a_j,x_i) \Big) \right) 
         \Bigg\{
               \Pi^R\Big( a_j, x_i \Big) + \beta\sum_{a_{j'}\in \mathcal{A} } \Pi(a_j,a_{j'})
               v \bigg( a_{j'},\frac{x_i}{\uppi^*} ; \ \bsy{\uptheta}^* \bigg) 
         \Bigg\}
   \end{align*}
   %%%
   where the decision rules must also satisfy the following at the grid points
   %%%
   \small \begin{align}
      %%
      \label{eq:policies_eq1}
      & \tilde{\xi}(a_j, x_i) = \frac{ V^A(a_j; \bsy{\uptheta}^*) - V^N(a_j, x_i ; \bsy{\uptheta}^*) }{ w^* } \\
      %%
      \label{eq:policies_eq2} 
      & 0 = Y^* \Big( \tilde{p}^a( a_j ) \Big)^{-\epsilon}   - 
         \epsilon Y^* \Big( \tilde{p}^a( a_j ) \Big)^{-\epsilon-1} \left( \tilde{p}^a( a_j ) - \frac{ w^* }{a_j} \right) +
         \beta 
         \Bigg[ 
               \sum_{a_{j'}\in \mathcal{A} } \Pi(a_j,a_{j'}) 
               \frac{ \partial v \big( a', \tilde{p}^a( a_j )/\uppi^* ; \bsy{\uptheta}^*\big) }{ \partial x' } \frac{1}{\uppi^*}
         \Bigg]
   \end{align} \normalsize
   %%%
   % %%
   % \item Note that the conditional expectation of the future value function has been broken into two components:
   % the expectation with respect to idiosyncratic shocks is taken explicitly by integration while the expectation 
   % with respect to the aggregate shocks is denoted by the expectation operator. 

   %%
   \item {\sc \color{RubineRed} Careful:} Note that the foc in the code is different since the value function there is defined in terms
   of $ \log $ price
\end{itemize}
%%%
% paragraph firm_s_value_function (end)

%%%%%%%%%%
\paragraph{Distribution} % (fold)
\label{par:distribution}

Different from usual applications, we have two relevant distributions here \\[-1.5\baselineskip]
%%%
\begin{itemize}[label=\raisebox{0.25ex}{\tiny $\bullet$ }]
   %%
   \item $ \Psi(a,x) $ : distribution over beginning-of-period (prior to the adjustment decision) relative prices 
   %%
   \item $ \widetilde{\Psi}(a, \tilde{p}) $ : distribution over effective real prices (production relevant) and idio shocks
\end{itemize}
%%%
The $\Psi$ distribution transition dynamics involves 3 different steps
%%%
\begin{enumerate}
   %%
   \item decision of price adjustment adjustment 
   %%
   \item exogenous transition
   %%
   \item deflation by inflation between $ t\mapsto t+1 $
\end{enumerate}
%%%
Details on the discretization of each distribution can be checked on Krusell-Smith model notes. Check the code to see
how I do the actual implementation of the three different steps. 

% The first option comes from \citet{reiter} and involves approximating both distributions by a finite number of mass
% points on a predefined grid on $ \mathcal{X} \defeq \big\{ x_i \big\}_{i=1}^{N_X} $ and productivity $\mathcal{A}$.
% %% 
% Let $ \widetilde{\Psi}( a_j, \tilde{p}_{-1} ) $ denote the fraction of firms at the beginning of the period with
% productivity level $ a_j $ and last period relative price of $ \tilde{p}_{-1}$. The evolution of this distribution
% involves the three steps discussed above. For any pairs $\Big\{ ( a_{j}, \tilde{p}_{\text{-} 1}^i ) , ( a_{j}, x_{i'}
% )\Big\}  \subset \mathcal{A}\times \mathcal{X} $, the probability of moving from the first to the second is
% %%%
% \begin{equation}
%    \label{eq:transition_inflation}
%    prob( \qquad ; \Pi) = 
%    \begin{cases}
%       \frac{ \Pi^{-1} \tilde{p}_{\text{-} 1}^i - x_{i'-1} }{ x_{i'} - x_{i'-1}}   & \text{if } x_{i'}=\min \big\{ x \in
%       \mathcal{X} : x \ge \Pi^{-1} \tilde{p}_{\text{-} 1}^i \big\} \\
%       \frac{ x_{i'+1} - \Pi^{-1} \tilde{p}_{\text{-} 1}^i }{ x_{i'+1} - x_{i'}}   & \text{if } x_{i'}=\max \big\{ x \in
%       \mathcal{X} : x < \Pi^{-1} \tilde{p}_{\text{-} 1}^i \big\}   \\ 0 & \text{ow}
%    \end{cases}
% \end{equation}
% %%%
% Then, for any pair $ ( a_{j}, \tilde{p}^i ) \in \mathcal{A}\times \mathcal{X} $, next period ${\Psi}'$
% %%
% \begin{equation}
%    \Psi^{\prime} \Big( a_{j}, \tilde{p}^{i'} \Big) =  
%          \omega_{j, i'} \sum_{ i=1 }^{N_X} \xi_{j,i} \times \widetilde{\Psi}(a_j, x_i) + 
%          (1-\xi_{ j,{i'} }) \times \widetilde{\Psi}(a_j, x_{i'} )
% \end{equation}
% where $\omega_{j, i'}$
% \begin{equation*}
%    \label{eq:weight}
%    \omega_{j,i'} = \begin{cases}
%    \frac{ \tilde{p}_j - \tilde{p}^{i'-1} }{ \tilde{p}^{i'} - \tilde{p}^{i'-1} } & \text{ if } \tilde{p}_j \in \Big[
%    \tilde{p}^{i'-1},\tilde{p}^{i'} \Big] \\ \ & \ \\
%    \frac{ \tilde{p}^{i'+1} - \tilde{p}_j }{ \tilde{p}^{i'+1} - \tilde{p}^{i'} } & \text{ if } \tilde{p}_j \in \Big[
%    \tilde{p}^{i'},\tilde{p}^{i'+1} \Big] \\ \ & \ \\ 0 & \text{o.w.}
%    \end{cases}
% \end{equation*}
% paragraph distribution (end)

%%%%%%%%%%
\paragraph{Finite Dimensional System} % (fold)
\label{par:finite_dimensional_system}
\ \bigskip
%%%
% \begin{equation*}
   % \label{eq:}
\footnotesize
   \begin{empheq}[left=\empheqlbrace]{gather*} 
      %% HOUSEHOLD
      \beta \left( \frac{Y'}{Y} \right)^{-\sigma} \frac{1}{\uppi'}R -1 \\
      N^{1/\varphi}  - \frac{1}{\chi} Y^{-\sigma} w \\ \ \\
      % -----------------------------------------------------------------------------------------------------   
      %% Market Clearing conditions
      % Labor Market 01
      N - \int 
            \Bigg[ 
                  H\Big( \tilde{\bsy{\xi}}_{j,i} \Big) 
                     \frac{ \big( \tilde{p}^a(a) \big)^{-\epsilon} Y }{ Za } +
                  \left( 1- H\Big( \tilde{\bsy{\xi}}_{j,i} \Big) \right) 
                     \frac{ x^{-\epsilon} Y }{ Za } +
                  \int_0^{ \tilde{\bsy{\xi}}_{j,i} } \xi dH(\xi)
            \Bigg] d\Psi(\uppi) \\
      N - Y \int \frac{\tilde{p}^{-\epsilon}}{Za} d\tilde{\Psi'}(\uppi) +
                  \int \Bigg[ \int_0^{ \tilde{\bsy{\xi}}_{j,i} } \xi dH(\xi)
            \Bigg] d\Psi(\uppi) \\
      % Consistency price 1
      % 1 - \int 
      %       \Bigg[ 
      %             H\Big( \tilde{\bsy{\xi}}_{j,i} \Big) \big( \tilde{p}^a ( a ) \big)^{1-\epsilon} + 
      %             \left( 1- H\Big( \tilde{\bsy{\xi}}_{j,i} \Big) \right) x^{1-\epsilon}
      %       \Bigg] d\Psi(\uppi)\\
      % Consistency price 2
      1 - \int \tilde{p}^{1-\epsilon} d\tilde{\Psi'}(\uppi) \\ \ \\
      % -----------------------------------------------------------------------------------------------------   
      %%% Dynamics of the Distribution
      \text{Distribution Dynamics}      \\ \ \\
      % -----------------------------------------------------------------------------------------------------   
      %% Exogenous
      z'  - \rho_z z - \sigma_{z} \omega_z' \\
      \epsilon'  - \rho_{\epsilon} \epsilon - \sigma_{\epsilon} \omega_{\epsilon}' \\ \ \\
      % -----------------------------------------------------------------------------------------------------   
      %% Value Function
      v(a_j,x_i; \bsy{\uptheta} ) - H\Big( \bsy{\tilde{\xi}}_{j,i} \Big) 
         \Bigg\{
                  \Pi^R \Big( a_j, \bsy{p}^a_{j} ; \ \cdot \ \Big) + 
                  \beta \left( \frac{Y'}{Y} \right)^{-\sigma}  \sum_{j'} \Pi[ a_j,a_{j'} ] 
                  % \Big( \bsy{V}',v^* \Big) \left( a_{j'}, \frac{\bsy{p}^a_{j}}{ \uppi' } \right)
                  \Big( \bsy{V}',v^* \Big) \left( a_{j'}, \frac{\bsy{p}^a_{j}}{ \uppi' } ; \bsy{\uptheta}' \right)
         \Bigg\} \\
         \hspace{1in} + w \int_0^{ \tilde{\bsy{\xi}}_{j,i} } \xi dH(\xi)
         - \left( 1- H\Big(  \tilde{\bsy{\xi}}_{j,i}  \Big) \right) 
         \Bigg\{
               \Pi^R\Big( a, x_i ; \ \cdot \ \Big) + 
               \beta\sum_{j'} \Pi(a_j,a_{j'})
                  % \Big( \bsy{V}',v^* \Big) \bigg( a_{j'}, \frac{x_i}{ \uppi' } \bigg)
                  v\bigg( a_{j'}, \frac{x_i}{ \uppi' } ; \bsy{\uptheta}' \bigg)
         \Bigg\} \\
      % -----------------------------------------------------------------------------------------------------   
      %% FOC
         \frac{ \partial \Pi^R}{ \partial \tilde{p} } \Big( a_j, \bsy{p}^a_j ; \ \cdot \ \Big) + \beta \left(
         \frac{Y'}{Y} \right)^{-\sigma}  \sum_{j'} \Pi[ a_j,a_{j'} ]
                  % \frac{ \partial \Big( \bsy{V}',v^* \Big) }{ \partial x' } \left( a_{j'}, \frac{\bsy{p}^a_{j}}{ \uppi' } \right) \frac{1}{\uppi'}
                  \frac{ \partial v  }{ \partial x' } \left( a_{j'}, \frac{\bsy{p}^a_{j}}{ \uppi' }; \bsy{\uptheta}' \right) \frac{1}{\uppi'}
   \end{empheq}
\normalsize 
% \end{equation*}

With all these approximations, the recursive equilibrium becomes computable. 
It resumes to a system of nonlinear equations $ f $ that satisfies
%%%
\begin{equation}
   \label{eq:equil_conditions}
   \mathbb{E} \Big[ f \big( \mathbf{y}',\mathbf{y}, \mathbf{x}', \mathbf{x} \big) \Big] = 0
\end{equation}
%%%
where $ \textbf{y} = \big( Y,N,R,\uppi,w,\bsy{\uptheta},\bsy{p}^a \big) $ are the \emph{control} variables%
\footnote{
Although we have introduced $ \bsy{\uptheta} $ as the variable on the system $f$, we actually treat the value function
differently on the steady-state and linearization steps. To compute the stationary equilibrium, the description above is
precise. Now, let $\uptheta^*$ be the coefficients on the steady-state value function of the firm. At the linearization
step, instead of perturbing the coefficients $ \uptheta $ we use as variable $ \big\{ \bsy{V}_{i,j} \big\} $ with
steady-state values $\bsy{V}_{i,j}^* = v( a_j,x_i ;\uptheta^* ) $. To evaluate points outside the grid, we use 
\[
   \Big( \bsy{V}, v^* \Big) \big( a,x \big) = v^*( a, x; \uptheta^*) + \frac{x-x_i}{x_{i+1} - x_i}d\bsy{V}_{i+1,j}
   + \frac{x_{i+1} - x}{x_{i+1} - x_i}d\bsy{V}_{i,j}
\]
Check the codes for more details.
}, 
$ \mathbf{x} = \big(\widetilde{\Psi}_{-}, \uppsi \big) $ are the (endogenous and exogenous) \emph{state} variables.
This puts the model in the canonical form presented in. % \citet{schmitt-uribe}. 
% paragraph finite_dimensional_system (end)

% which we can recast on Sims form
%%%
% \begin{equation}
%    \label{eq:sims_format}
%    \Gamma_0 X_t = \Gamma_1 X_{t-1} + \Psi \epsilon_t + \Pi \eta_t
% \end{equation}
% %%%
% by defining $ X_t = \Big[ \mathbf{y}_t,\mathbf{x}_t \Big] $ and introducing endogenous forecast errors $ \eta_t $
% for the control variables $ E_t \Big[ \mathbf{y}_{t+1} \Big] = \mathbf{y}_{t+1} - \eta_{t+1} $. The expectation over states
% next period is dealt by recognizing that uncertainty there is only related to the evolution of the exogenous process, which
% are explicitly in \eqref{eq:sims_format} through $\epsilon_t$.
% %
% Doing that, we are able to represent \eqref{eq:linearized_equil_conditions} in the form \eqref{eq:sims_format}
% with coefficients
% \[
%    \Gamma_0 = [ -f_{\mathbf{y}'} \ -f_{\mathbf{x}'}], \quad \Gamma_1 = [ f_{\mathbf{y}} \ f_{\mathbf{x}}], \quad \Pi = -f_{\mathbf{y}'}
% \]
% where yt is an nÃ—1 vector of endogenous variables, \EPSILON is a lÃ—1 vector of exogenous,
% serially uncorrelated random disturbances, \eta_t is a k Ã— 1 vector of expectation
% errors, satisfying Etâˆ’1[\etat ]=0 for all t. \Gamma_0 and \Gamma_1 are nÃ—n coefficient matrices, while
%   \Psi  is nÃ—l and \Pi
%  is nÃ—k

%%%
% Subsection finite_dimensional_approximation (end)
%..........................................................................................................................

%%%%%%% Stationary Equilibrium  
%--------------------------------------------------------------------------------------------------------------------------
\subsection{Stationary Equilibrium} % (fold)
\label{sub:stationary_equilibrium}

In the stationary equilibrium, aggregate shocks are zero and distribution of effective prices converges to an ergodic distribution $
\widetilde{\Psi} $ so aggregate state is constant. In terms of the finite dimensional system presented above, the stationary equilibrium are values
$ \mathbf{x}^*,\mathbf{y}^* $ such that $ f \big( \mathbf{y}^*,\mathbf{y}^*, \mathbf{x}^*, \mathbf{x}^* \big) = 0 $

The following algorithm searchs for an stationary equilibrium by nesting the firm's problem inside an outer loop over steady-state
real-wage $w$ and production $ Y^* $
%%%
\begin{enumerate}
   
   %%
   \item Guess a pair $ w^*,Y^* $
   %%
   \item Given $ \Big(w^*,Y^* \Big) $, compute the firm's value function.
   %%
   \item Using the firm's decision rules, compute the invariant distribution.
   %%
   \item Check the market-clearing and consistency conditions
      %%%
      \begin{align*}
         %%
         % \label{eq:_eq1}
         1 & = \int \tilde{p}^{1-\epsilon} \Psi\big(da, d\tilde{p} \big) \\
         %%
         % \label{eq:_eq2}
         N^* & = 
         \int \ell \big( a, \tilde{p} \big) \Psi \big(d[a\times\tilde{p}] \big) + 
         \int \left( \int^{\tilde{\xi}( a, x) } \zeta dH( \zeta) \right) \widetilde{\Psi} \big( d[a\times x] \big)
      \end{align*}
      %%%
\end{enumerate}
%%%
% Subsection stationary_equilibrium (end)
%..........................................................................................................................


% SECTION METHOD (END)
%..................................................................................................


\newpage
%**************************************************************************************************
%%%%%%% LINEAR_RATIONAL_EXPECTATIONAL_DIFFERENCE_EQUATIONS
%--------------------------------------------------------------------------------------------------
\section{Linear Rational Expectational Difference Equations} % (fold)
\label{sec:linear_rational_expectational_difference_equations}

Linearizing \eqref{eq:equil_conditions} around the steady-state yields a first-order linear expectational difference
equation system of the form
%%%
\begin{equation}
   \label{eq:linearized_equil_conditions}
   f_{ \mathbf{y}' } E_t \Big[ \underbrace{ ( \mathbf{y}_{t+1} -  \bar{\mathbf{y}}) }_{ \tilde{\mathbf{y}}_{t+1} } \Big] 
   + f_{ \mathbf{y} }   \tilde{\mathbf{y}}_t  
   + f_{ \mathbf{x}' }  E_t \Big[  \tilde{\mathbf{x}}_{t+1} \Big]
   + f_{ \mathbf{x} }   \tilde{\mathbf{x}}_{t}
   = 0
\end{equation}
%%%
I am going to present two different methods to solve the linear rational expectation model \eqref{eq:linearized_equil_conditions}.
Section \ref{sub:klein} shows the Klein's method which follows closely the Blanchard and Kahn approach, while section \ref{sub:sims}
discusses Sim's method.

The differences between the two methods lies in the how they pin down the one-step-ahead prediction error of the
endogenous variables. As is made clear in Klein's paper
\begin{quote}\small
   In Sims (1996), the approach is as follows. First, the equation is written without expectational terms but with an endogenous
   prediction error process. The system is then transformed into a triangular one using the generalized Schur form, and the unstable
   block of equations is isolated. This block is then solved forward, and the endogenous prediction error process is solved for by
   imposing the informational restriction that the solution must be adapted to the given filtration. At this stage, no extraneous
   assumptions (e.g. about what variables are predetermined) are invoked; all information about the solution is given in the
   coefficient matrices of the difference equation itself.

   By contrast, the approach in this paper follows very closely the one used in Blanchard and Kahn (1980). No endogenous prediction
   error is introduced, and the unstable block of the triangular system is solved forward without having to solve for the prediction
   error separately. Instead, the endogenous prediction error process is solved for when solving the stable block of equations and use
   is then made of extraneous assumptions which generalize Blanchard and Kahn's assumption of certain variables being predetermined.
\end{quote}\normalsize

Before discussing the methods, let me just show how \eqref{eq:linearized_equil_conditions} can be cast into the canonical forms of both models

%%%%%%%%%%
\paragraph{\normalfont\bf Klein's form.} % (fold)
\label{par:klein}
Let's start by putting \eqref{eq:linearized_equil_conditions} on Klein's notation. Let $ A \defeq \big[f_{ \mathbf{x}' }
\quad f_{ \mathbf{y}' } \big] $  and $ B \defeq - \big[f_{ \mathbf{x} } \quad  f_{ \mathbf{y} } \big] $, from what we
get
%%%
\begin{equation}
   \label{eq:klein}
   A E_t \left\{ 
   \begin{bmatrix}
      \mathbf{x}_{t+1} \\ \mathbf{y}_{t+1}
   \end{bmatrix}
   \right\} = 
   B 
   \begin{bmatrix}
      \mathbf{x}_{t} \\ \mathbf{y}_t 
   \end{bmatrix}
\end{equation}
% paragraph klein (end)
%.........................................................

%%%%%%%%%%
\paragraph{\normalfont\bf Sims's form.} % (fold)
\label{par:sims_form}

Let $X_t \defeq ( \tilde{\mathbf{x}_t}; \ \tilde{\mathbf{y}_t} )$. To put the model into Sims' format, we need to get rid of
the expectational terms in
\begin{equation*}
   \Gamma_0 \mathbb{E}_t \Big[ X_{t+1} \Big] = \Gamma_1 X_t
\end{equation*}
where $ \Gamma_0, \Gamma_1$ are defined as before. To do so we substitute $ E_{t} \big\{X_{t+1}\big\} $ by the
combination of its \emph{ex post} realizations plus the appropriate forecast errors.\footnote{%
   For each $y_{i,t+1}$, whenever we have $ E_{t} \big\{ y_{i,t+1} \big\}  $  we substitute to $ y_{i,t+1} - \eta_{i,t+1}$, 
   where $\eta_{i,t+1} $  are \textbf{endogenous} expectational errors determined as part of the solution.
   Endogenous states are all pre-determined, so $ E_t\{x_{1,t+1}\} = x_{t+1} $, while exogenous states have exogenous
   forecast error $ \omega_{t+1} $, so we can write $ E_t \{\mathbf{x}_{2,t+1} \} = \mathbf{x}_{2,t+1} - \omega_{t+1}$
   }
Once we do that, we get to Sims' canonical form.
% paragraph sims_form (end)
%.........................................................

%%%%%%% Preliminaries  
%--------------------------------------------------------------------------------------------------------------------------
\subsection{Preliminaries} % (fold)
\label{sub:preliminaries}

\begin{definition}
   Let $ P\in \mathbb{C}\rightarrow \mathbb{C}^{n\times n} $ be a matrix-valued function of a complex variable (a matrix
pencil). Then the set of its generalized eigenvalues $ \lambda( P) $ is defined as
\[
   P(z) \defeq \big\{ z\in \mathbb{C}: \lvert P(z) \rvert = \mathbf{0} \big\}
\]
When $P(z)$ writes as $Az-B$, we denote this set as $\lambda(A,B)$. Then there exists
a vector $V$ such that $BV = \lambda AV$ .
\end{definition}

\begin{theorem}[The complex generalized Schur form]
Let $A$ and $B$ belong to $ \mathbb{C}^{n\times n} $ and be such that $ P(z) = Az - B$ is a regular matrix pencil. Then
there exist \textbf{unitary} (orthogonal) $n\times n$ matrices of complex numbers $Q$ and $Z$ such that
%%%
\begin{enumerate}
   
   %%
   \item $ S = Q A Z $ is upper-triangular
   %%
   \item $ T = Q B Z $ is upper-triangular
   %%
   \item For each $ i $, $ s_{ii},t_{ii}$ are not both zero
   %%
   \item $ \lambda(A,B) = \left\{ \frac{t_{ii}}{s_ii} : \ s_{ii}\ne 0 \right\}$
   %%
   \item The pairs $ (s_{ii}, t_{ii} ) $ can be arranged in any order
\end{enumerate}
%%%
Note that the set $ \lambda(A,B) $ may have fewer than $ n $ elements, since if $ A $ is singular, we may have $
s_{ii}=0 $ for some $ i $. The missing generalized eigenvalues will be called infinite. These, together with the finite
generalized eigenvalues with $ \{\lambda_i \} >1$ will be denominated \emph{unstable}. 
\end{theorem}

\begin{theorem}[\emph{Singular Value Decomposition}]
   Every $m\times n $ complex matrix $ A $ can be factored into a product of three matrices
   %%%
   \begin{equation}
      \label{eq:SVD}
      A = U S V'
   \end{equation}
   %%%
   called a \emph{singular value decomposition (SVD)} where \\[-1.5\baselineskip]
   %%%
   \begin{itemize}[label=\raisebox{0.25ex}{\tiny $\bullet$ }]
      %%
      \item $ U _{m\times m}, V_{n\times n}$ are orthogonal matrices - $ UU' = VV' = I $
      %%
      \item $ S $ is a diagonal matrix having the first $r$ diagonal entries $ \sigma_1 \ge \sigma_2 \ge \ldots \ge \sigma_{r} > 0$
      and all other entries zero. \\[-1.5\baselineskip]
   \end{itemize}
   %%%
   The values $ \sigma_i $ are called the \textbf{singular values} of $ A $, while the column vectors $ u_j,v_i $ are
   the left/right \textbf{singular vectors}. Note that the SVD allows us to write the matrix $ A $ as 
   \[
      A = \sum_{i=1}^r \sigma_i u_i v_i^T
   \]
   where the vectors $ u_1, \ i=1,\ldots,r $ (resp. $ v_1, \ i=1,\ldots,r $) are mutually orthogonal. 
\end{theorem}
It is convenient at this point to state  some properties of the SVD that will be useful for the applications later on. 
\pagebreak 

\begin{claim} \ \\[-1.5\baselineskip]
   %%%
   \begin{enumerate}
      \item The rank of $ A $ is the cardinality of the nonzero singular values
      \item An orthonormal basis spanning $ \mathcal{N}(A) $ is given by the last $ n-r $ columns of $ V $
      \item An orthonormal basis spanning the range of $ A $ is given by the first $ r $ columns of $ U $, i.e., 
      \[
         \mathcal{R}(A) = \mathcal{R} \big(  \{ u_1, \ldots, u_r \}  \big)
      \]
   \end{enumerate}
   %%%
\end{claim}


% Subsection preliminaries (end)
%..........................................................................................................................

%%%%%%% Klein  
%--------------------------------------------------------------------------------------------------------------------------
\subsection{Klein} % (fold)
\label{sub:klein}

%%%
Consider the generalized Schur decomposition of $ A, B $ 
%%%
\begin{equation}
   % \label{eq:}
   Q A Z = S \qquad Q B Z = T
\end{equation}
%%%
where $ A,B $ are upper triangular and $ Q,Z$ are orthonormal matrices. Let $ S $ and $ T $ be arranged in such a way
that the $ n_s $ stable eigenvalue come first. Partition the rows of $ Z $ conformably with the classification of
eigenvalues and the columns with the sizes of $ \mathbf{x},\mathbf{y} $
%%%
\begin{equation*}
   % \label{eq:}
   Z = 
   \begin{bmatrix}
      Z_{11} & Z_{12} \\ Z_{21} & Z_{22}
   \end{bmatrix}
\end{equation*}
%%%
At this point, let's assume that
\begin{assump}
   $ Z_{11} $ is square and invertible. 
\end{assump}
Note that the assumption requires $n_s - n_x$. This means that there should be as many state variables - variables with
exogenously given initial values and prediction error - as there are stable eigenvalues. Now, in order to find a
solution define the auxiliary variables $ w_t $ as
%%%
\begin{equation}
   \label{eq:aux}
   w_t \defeq Z^{H} \big[ \mathbf{x}_t' \ \  \mathbf{y}_t' \big]' =
   \begin{bmatrix}
      s_t \\ u_t
   \end{bmatrix}
\end{equation}
%%%
where the transformed variable $ w_t $ is divided into $ n_s\times 1 $ stable and $ n_u \times 1 $ unstable components. 
Premultiply the system by $ Q $ to get 
%%%
\begin{equation}
   % \label{eq:}
   \begin{bmatrix}
      S_{11} & S_{12} \\ 0 & S_{22}
   \end{bmatrix}
   E_t \left\{
   \begin{bmatrix}
      s_{t+1} \\ u_{t+1}
   \end{bmatrix} \right\}
    = 
    \begin{bmatrix}
       T_{11} & T_{12} \\ 0 & T_{22}
    \end{bmatrix}
    \begin{bmatrix}
      s_{t} \\ u_{t}
   \end{bmatrix}
\end{equation}
%%%
We start by solving for $u_t$. Since the generalized eigenvalues of  $ \big( S_{22}, T_{22} \big) $ are all
unstable, the solution is found by solving forward in time
%%%
\begin{equation}
   \label{eq:unstable_sol}
   u_t = \lim_{s \rightarrow \infty }\big( T_{22}^{-1} S_{22} \big)^{s} E_t\{ u_{t+1} \} = 0
\end{equation}
%%%
where last inequality comes from the fact we are interested in stable equilibrium paths $ u_t $. 
Using this on the first block we get
%%%
\begin{equation}
   \label{eq:cond_01}
   E_t\big\{ s_{t+1} \big\}  = S_{11}^{-1} T_{11} s_t
\end{equation}
%%%
Recalling the definition of $ s_t $
%%%
\begin{equation*}
   % \label{eq:}
   \mathbf{x}_{t+1} = 
      \begin{bmatrix}
         Z_{11} & Z_{12}
      \end{bmatrix} 
      \begin{bmatrix}
         s_{t+1} \\ u_{t}
      \end{bmatrix}
\end{equation*}
%%%
and our definition of $ \mathbf{x}_{t+1} $ as pre-determined in the sense of Klein
%%%
\begin{equation}
   \label{eq:cond_02}
   Z_{11} \Big( s_{t+1} -  E_t\{ s_{t+1} \}\Big) = \eta \epsilon_{t+1}
\end{equation}
%%%
Taken together, \eqref{eq:cond_01} and \eqref{eq:cond_02} define the unique solution for $ s_t $ given the exogenous process $ \epsilon $
%%%
\begin{equation}
   \label{eq:stable_sol}
   s_{t+1} = S_{11}^{-1} T_{11} s_t + Z_{11}^{-1} \eta \epsilon_{t+1}
\end{equation}
%%%
with $ s_0 = Z_{11}^{-1} \mathbf{k}_0 $. We can now go back to the relation $ Z^H \Big[\mathbf{x}_t' \ \
\mathbf{y}_t'\Big]' \eqdef w_t$ to find a recursive solution only in terms of the variables of interest. Using the
restriction on the control \eqref{eq:unstable_sol}
%%%
\begin{align*}
   %%
   % \label{eq:_eq1}
   Z^H_{21} \mathbf{x}_t + Z^H_{22} \mathbf{y}_t = 0 \Rightarrow \mathbf{y}_t & = - \big( Z^H_{22} \big)^{-1} Z^{H}_{21} \mathbf{x}_t 
   & \quad \quad & \notag \\
   %%
   % \label{eq:_eq2}
   & = \big( Z^H_{22} \big)^{-1} Z^H_{22} Z_{21} Z_{11}^{-1} \mathbf{x}_t \notag \\
   & = Z_{21} Z_{11}^{-1} \mathbf{x}_t
\end{align*}
%%%
As for state variables $ \mathbf{x}_t $, note that
%%%
\begin{align*}
   s_t & = Z^H_{11}\mathbf{x}_t + Z^H_{12} \mathbf{y}_t \\
       & = \Big( Z^H_{11} + Z^H_{12} Z_{21}Z_{11}^{-1} \Big) \mathbf{x}_t \\
       & = \bigg( Z^H_{11} + \Big( Z_{11}^{-1} - Z^H_{11} \Big) \bigg) \mathbf{x}_t \\
       & = Z_{11}^{-1} \mathbf{x}_t
\end{align*}
%%%
which together with \eqref{eq:stable_sol} implies
%%%
\begin{equation*}
   % \label{eq:}
   \mathbf{x}_{t+1} = Z_{11} S_{11}^{-1} T_{11} Z_{11}^{-1} \mathbf{x}_t + \eta \epsilon_{t+1}
\end{equation*}
%%%
Putting it together we have
%%%
\begin{equation}
   \label{eq:solution_klein}
   \begin{cases}
       \mathbf{x}_{t+1} = Z_{11} S_{11}^{-1} T_{11} Z_{11}^{-1}\mathbf{x}_t + \eta \epsilon_{t+1}, \quad \mathbf{x}_0 \text{ given } \\
       \mathbf{y}_t = Z_{21} Z_{11}^{-1} \mathbf{x}_t
   \end{cases}
\end{equation}
%%%

% Subsection klein (end)
%..........................................................................................................................

%%%%%%% Sims  
%--------------------------------------------------------------------------------------------------------------------------
\subsection{Sims} % (fold)
\label{sub:sims}

We concentrate in solving model that can be cast into the following form
%%%
\begin{equation}
   \label{eq:sims_format}
   \Gamma_0 y_t = \Gamma_1 y_{t-1} + \Psi \epsilon_t +\Pi \eta_t
\end{equation}
%%%
where $ y_t $ is a $ n\time 1 $ vector of endogenous variables, $ \Gamma_0,\Gamma_1 $ are $ n\times n $ coefficients matrices , $
\epsilon_t $ is a $ \ell\times 1 $ vector of \emph{exogenous} random disturbances, $ \eta_t $ is an $ k\times 1 $ vector of
\emph{endogenous} expectational errors satisfying $ E_t \big[ \eta_{t+1} \big] =0 $. Note that $ \eta_t $ terms are not given
exogenously, instead they are determined as part of the solution. This method uses the notation that in which time arguments relate
consistently to the information structure, meaning that variables date $ t $ are always know at date $ t $.

%%%%%%% Special Case  
%------------------------------------------------------------------------------------------------------------
\subsubsection{Special Case} % (fold)
\label{sub:special_case}

Consider the special case of when the $ \Gamma_0 $ is non-singular. Hence, we can represent \eqref{eq:sims_format} as
\[
   y_t = \Gamma y_{t-1} + \Psi \epsilon_t +\Pi \eta_t
\]
Assume that the matrix $ \Gamma $ can be diagonalized to
\[
   \Gamma = P \Lambda P^{-1}
\]
where $ P $ is the matrix of right-eigenvectors of $ \Gamma $, $ P^{-1} $ is the matrix of left-eigenvectors
and $ \Lambda $ is the diagonal matrix of eigenvalues. Multiplying the system by $ P^{-1} $ and defining $ w \defeq P^{-1} y $
we arrive at
%%%
\begin{equation}
   \label{eq:diag_system}
   w_t = \Lambda w_{t-1} + P^{-1} \Big( \Psi \epsilon_t + \Pi \eta_t \Big)
\end{equation}
%%%
Since $\Gamma$ is diagonal the system breaks into unrelated components
%%%
\begin{equation}
   \label{eq:single_eq}
   w_{j,t} = \lambda_j w_{j,t-1} + \tilde{P}_{j\cdot} \Big( \Psi \epsilon_t + \Pi \eta_t \Big)
\end{equation}
%%%
If the disturbance term, including the combined effects of $\epsilon$ and $\eta$, is zero and $ \lambda_j \ne 1$, the model has a
deterministic steady-state solution
%%%
\begin{equation}
   \label{eq:restriction}
   w_{j,t} = 0 
\end{equation}
%%%
Moreover, for any $ \lvert \lambda_j \rvert > 1$, then $ E_t\big[ w_{j,t+\tau} \big] $ diverges as $ \tau\rightarrow \infty $ for any
solution other then $ w_{j,t} = 0 $. If we are looking for a \emph{stationary equilibrium}, every one of 
the variables $ w_j $ corresponding to $ \lvert \lambda_j \rvert > 1 $ and to $ P_{j,:}\ne 0 $ must be set to its steady-state value. 
If we impose \eqref{eq:restriction} for all $ t $ in \eqref{eq:single_eq} we get
%%%
\begin{equation}
   \label{eq:eta_rest_01}
   \tilde{P}_{j\cdot} \Big( \Psi \epsilon_t + \Pi \eta_t \Big) = 0 
\end{equation}
%%%
Collecting all the rows of $ P^{-1} $ for which \eqref{eq:eta_rest_01} holds into a single matrix $ \tilde{P}^U $, 
we can write
%%%
\begin{equation}
   \label{eq:eta_rest_02}
   \tilde{P}^U \Big( \Psi \epsilon + \Pi \eta \Big) = 0
\end{equation}
%%%
Existence problems arise if the endogenous shocks $ \eta $ cannot adjust to offset the exogenous disturbances $ \epsilon
$. This accounts for the usual notion that there are existence problems if the number of \emph{unstable roots} exceeds
the number of \emph{jump variables}. The precise condition here is that the columns of $ \tilde{P}^U \Pi $  span the
space spanned by the columns of $ \tilde{P}^U \Psi $, i.e.
%%%
\begin{equation}
   \label{eq:iexistence}
   \text{span} \Big( \tilde{P}^U \Psi \Big) \subset \text{span} \Big( \tilde{P}^U \Pi \Big) \Leftrightarrow
   \tilde{P}^U \Psi = \tilde{P}^U \Pi \underbrace{\lambda}_{ k \times \ell }
\end{equation}
%%%
From \eqref{eq:eta_rest_02}, we have an expression that will determine $ \tilde{P}^U \Pi \eta $ from information of the stochastic
process $ \epsilon_t $. However, multiple solutions may exist when \eqref{eq:iexistence} puts too few restrictions. For the solution to
be unique, it must be that \eqref{eq:eta_rest_02} pins down not only the value of $ \tilde{P}^U \Pi \eta $ but also $ \tilde{P}^S \Pi
\eta$, which resumes the impact of expectational shocks on the stable block of the system \eqref{eq:diag_system}. Formally, we require
the row space of $\tilde{P}^S \Pi  $ to be included into the row space of $ \tilde{P}^U \Pi $.
% %%%
% \begin{equation}
%    \label{eq:iuniqueness}
%    \text{span} \Big( \big( \tilde{P}^S \Pi \big)' \Big) \subset \text{span} \Big( \big( \tilde{P}^U \Pi \big) \Big)
% \end{equation}
% %%%
In that case, there exists $ \Phi $ such that
%%%
\begin{equation}
   \label{eq:row_space_transf}
   \tilde{P}^S \Pi = \Phi \tilde{P}^U \Pi
\end{equation}
%%%
If this is the case, we can write the solution by assembling the equations representing the stability conditions \eqref{eq:restriction}
together with the lines of \eqref{eq:diag_system} that determine $ w $ for the stable block and use \eqref{eq:row_space_transf} to
eliminate the dependence over $ \eta $
%%%
\begin{equation}
   \label{eq:system1_simul}
   \begin{bmatrix}
      w^S_{t} \\ w^U_{t}
   \end{bmatrix} = 
   \begin{bmatrix}
      \Lambda_S \\ \mathbf{0}
   \end{bmatrix} w^S_{t-1}
   \begin{bmatrix}
      I & -\Phi  \\ \mathbf{0} & \mathbf{0}
   \end{bmatrix}
   \begin{bmatrix}
      \tilde{P}^S \\ \tilde{P}^U
   \end{bmatrix}
   \Psi \epsilon_t
\end{equation}
%%%
Multiply by $ P $ to go back to $ y $
%%%
\begin{equation}
   \label{eq:system2_simul}
   y_t = \underbrace{P_{:,S} \Lambda_S \tilde{P}^S}_{ \Theta_y } y_{t-1} + 
         \underbrace{\Big( P_{:,S} \tilde{P}^S - P_{:,S} \Phi \tilde{P}^U \Big) \Psi}
         _{\Theta_{\epsilon}} \epsilon_t
\end{equation}
%%%

% Subsection special_case (end)
%..................................................................................................

%%%%%%% General CAse  
%--------------------------------------------------------------------------------------------------
\subsubsection{General CAse} % (fold)
\label{sub:general_case}
First, we compute the \emph{Generalized Schur decomposition} to find matrices $ Q,Z,T $ and $ S $ such that
%%%
\begin{align}
   %%
   % \label{eq:_eq1}
   & Q' S Z' = \Gamma_0, \qquad Q' T Z' = \Gamma_1 \\
   %%
   % \label{eq:_eq2}
   & QQ' = ZZ' = I_{n\times n}
\end{align}
%%%
Let us define $ w_t = Z'y_t $ and pre-multiply the system by $ Q $ in order to get
%%%
\begin{equation}
   \label{eq:QZsims_eq01}
   \begin{bmatrix}
      S_{11} & S_{12} \\ 0 & S_{22}
   \end{bmatrix}   
   \begin{bmatrix}
      w_{1,t} \\ w_{2,t}
   \end{bmatrix} = 
   \begin{bmatrix}
      T_{11} & T_{12} \\ 0 & T_{22}
   \end{bmatrix}
   \begin{bmatrix}
      w_{1,t-1} \\ w_{2,t-1}
   \end{bmatrix} +
   \begin{bmatrix}
      Q_1 \\ Q_2
   \end{bmatrix}
   \Big( \Psi \epsilon_t + \Pi \eta_t \Big) 
\end{equation}
%%%
Let's focus on the explosive part of the system 
\[
   S_{22} w_{2,t} = T_{22} w_{2,t-1} + Q_2\Big( \Psi \epsilon_t + \Pi \eta_t \Big) 
\]
While the diagonal elements of $ S_{22} $ can be null, $ T_{22} $ is necessarily full rank. Therefore, we can solve
forward for $ w_{2,t-1} $. Start by leading the equation by one period and writing it in terms of $ w_{2,t} $
\[
   w_{2,t} = M z_{2,t+1} - T_{22}^{-1} Q_2 \Big( \Psi \epsilon_{t+1} + \Pi \eta_{t+1} \Big) 
\]
where $ M \defeq T_{22}^{-1} S_{22} $. Recursive substitution of $ w_{2,t+1} $ leads us to 
\[
   w_{2,t} = - \sum_{i=1}^{\infty} M^{i-1} T_{22}^{-1} Q_2 \Big( \Psi \epsilon_{t+i} + \Pi \eta_{t+i} \Big)
\]
where we imposed $ \lim M^t w_{2,t} = 0 $ since we are searching for a non-explosive solution of the LRE model
\eqref{eq:sims_format}. Since $ y_{t} $ is known at time $t$, $ w_{2,t} = E_t \{w_{2,t} \}$ which implies
\[
   w_{2,t} = - \sum_{i=1}^{\infty} M^{i-1} T_{22}^{-1} Q_2 
         \Big( 
            \Psi E_t\big\{ \epsilon_{t+i} \big\} + 
            \Pi E_t \big\{\eta_{t+i} \big\}
         \Big) = 0
\]
which imposes a restriction on paths for $ \epsilon_t$ and $\eta_t $. If we go back to \eqref{eq:QZsims_eq01} and take into account $
W_{2,t} = 0$  in the second block, this imposes
%%%
\begin{equation}
   \label{eq:QZsims_epislon_x_eta}
   \underbrace{Q_2 \Psi}_{ n_u \times \ell } \ \underbrace{\epsilon_t}_{ \ell \times 1 } 
   \quad + \quad 
   \underbrace{Q_2 \Pi}_{ n_u \times k }     \ \underbrace{\eta_t}_{k\times 1} = 0
\end{equation}
%%%
Note that the assertion in \eqref{eq:QZsims_epislon_x_eta} is only possible because we have the degree of freedom to choose $\eta$,
otherwise it requires that exogenously evolving events always satisfy a deterministic equation.
%
As before, existence problems arise if the endogenous shocks $ \eta $ cannot adjust to offset the exogenous shocks
$\epsilon $ in \eqref{eq:QZsims_epislon_x_eta}. Sufficient conditions for the existence of a unique stable solution are given below
\begin{assump} \ \\[-1.5\baselineskip]
   %%%
   \begin{enumerate}
      \item The columns space of $ Q_2 \Psi $ is contained in that of $ Q_2 \Pi $. 
      \item There exists an $ n_s\times n_u $ matrix $ \Phi $ such that
      \[
         Q_1 \Pi = \Phi \big( Q_2 \Pi \big)
      \]
   \end{enumerate}
   %%%
\end{assump}

How do we practically apply/check the conditions of the above assumption? Since the rows of the matrix $ Q_2\Pi $ are potentially linearly
dependent it is convenient to work with its Singular Value Decomposition discussed in the preliminaries
\[
   Q_2 \Pi = \underbrace{U}_{n_u \times n_u} \ \underbrace{S}_{ n_u\times k } \ \underbrace{V}_{k \times k} = 
   \begin{bmatrix}
      U_{.1} & U_{.2}
   \end{bmatrix}
   \begin{bmatrix}
      S_{11} & 0 \\ 0 & 0
   \end{bmatrix}
   \begin{bmatrix}
      V_{1.}' \\ V_{2.}'
   \end{bmatrix}
   =  \underbrace{U_{.1} }_{n_u \times r } \centerdot     
      \underbrace{S_{11} }_{ r  \times r } \centerdot    
      \underbrace{V_{1.}'}_{ r  \times k }   
\]
where $ S_{11} $ is a diagonal and $ U,V $ are orthonormal matrices. From previous claim, we can check whether $ Q_2 \Pi $'s column
space includes $ Q_2 \Psi $'s by checking $ \big(I-U_1U_{1}'\big)T = 0 $  where $ T $ comes from the SVD decomposition of $ Q_2\Psi = T
R W' $. If this holds, then it is easy to check
\[
   Q_2\Psi = Q_2 \Pi \underbrace{\Big( \big(V_1 S_{11}^{-1} U_1' \big) \centerdot Q_2 \Psi \Big)}_{ \lambda }
\]
is satisfied. Hence, we can rewrite \eqref{eq:QZsims_epislon_x_eta}
%%%
\begin{equation}
   % \label{eq:}
   U_1S_{11} \underbrace{\big( V_{1}'\lambda \epsilon_t +  V_{1}' \eta_t \big)}_{r\times 1} = \underbrace{0}_{n_u \times 1}
\end{equation}
%%%
We therefore now have $r$ restrictions to identify the $k$-dimensional vector of expectation errors.
% Subsection general_case (end)
%..................................................................................................

% Subsection sims (end)
%..........................................................................................................................

% SECTION LINEAR_RATIONAL_EXPECTATIONAL_DIFFERENCE_EQUATIONS (END)
%..................................................................................................


% ============================================================================================================
%------------------------------------------------ REFERENCE ------------------------------------------------
% ============================================================================================================
\clearpage
\newpage
%%%%% MAC
% \bibliographystyle{/Users/felipealves/Dropbox/TexFolder/plainnat2}
% \bibliography{/Users/felipealves/Dropbox/TexFolder/reiter_project}
%%%%% PC
\bibliographystyle{C:/Users/falves/Dropbox/TexFolder/plainnat2}
\bibliography{C:/Users/falves/Dropbox/TexFolder/reiter_project}

\newpage
\appendix
%%%%%%% Perturbing the value Function  
%------------------------------------------------------------------------------------------------------------
\section{Perturbing the value Function} % (fold)
\label{sub:perturbing_the_value_function}

function in Reiter: \texttt{BellmanIterGivenPolicy1dd}

We adopt the following approximation to perturb the value function
%%%
\begin{equation}
   \label{eq:interpol}
   \text{itp} \Big(  \bsy{V}, v^{*} \Big)(z_j, \tilde{x} ) = v^*( z_j, \bsy{x} ) + 
      \frac{ \tilde{x} - \bar{x}_i }{ \bar{x}_{i+1} - \bar{x}_i }    \Big( \bsy{V}_{j, i+1} - v^{*}( z_j, \bar{x}_{i+1}) \Big) +
      \frac{ \bar{x}_{i+1} -\tilde{x} }{ \bar{x}_{i+1} - \bar{x}_i } \Big( \bsy{V}_{j, i}   - v^{*}(z_j, \bar{x}_i) \Big)
\end{equation}
In steady state, $\bsy{V}_t[ j,i ] = v^* ( z_j,x_i ) $ so that in steady state the whole expression reduces to simply $ v^*( a, \tilde{x} ) $.
% Subsection perturbing_the_value_function (end)
%............................................................................................................

%%%%%%% How to do the perturbation of policy  
%------------------------------------------------------------------------------------------------------------
\section{How to do the perturbation of policy} % (fold)
\label{sub:how_to_do_the_perturbation_of_policy}

\texttt{policyPtyerturb1dd} for perturbation of policies

The policy outside steady state must satisfy
%%%
\begin{equation}
   \label{eq:maximization_prob}
   x_{t}'\Big( z, x \Big) = \argmax_{x'} \Bigg\{ U(z,x,x'; X_t) + \beta \ 
      \mathbb{E}_t
      \bigg[ 
         \sum_{ z' \in \mathcal{Z} } \Pi(z,z') \text{itp} \Big[ \bsy{V}_{t+1} , v^* \Big]( z', x' ) 
      \bigg]
      \Bigg\}
\end{equation}
%%%

Since it is optimal, it must satisfy the \emph{foc} for all realizations of aggregate state
%%%
\begin{equation}
   \label{eq:foc}
   % f(z,x; X_t, X_{t+1}) \defeq 
   \mathbb{E}_t 
   \left[
   U_{x'} \Big( z, x, \bsy{x}_t'(z,x); \bsy{X}_t \Big) + \beta
      \sum_{z \in \mathcal{Z} }  \Pi(z,z')
      \Bigg( 
         \frac{ \partial v^*(z', \bsy{x}_t'(z,x) ) }{ \partial x' } + 
         \frac{ d \bsy{V}_{t+1}[j,i+1 ] - d \bsy{V}_{t+1}[j,i] }{ \bar{x}_{i+1} - \bar{x}_{i} }
       \Bigg)
   \right] = 0
   \tag{dvdc}
\end{equation}
We know that at steady-state the policy computed in Step XX satisfy
%%%
\begin{equation*}
   \label{eq:focstst}
   0 = U_{x'} \Big( z, x, x'(z,x; X^*); X^* \Big) + \beta 
      \sum_{z \in \mathcal{Z} }  \Pi(z,z')
      \Bigg( 
         \frac{ \partial v^* \Big(z', x'(z,x; X^*) \Big) }{ \partial x' } +
         \frac{ d \bsy{V}^*_{j,i+1} - d \bsy{V}^*_{j,i} }{ \bar{x}_{i+1} - \bar{x}_{i} }
       \Bigg)
\end{equation*}
%%%
while the \emph{soc} again at steady state values satisfy
%%%
\begin{equation}
   \label{eq:soc}
   U_{x'x'} \Big( z,x, x'(z,x; X^*) ; X^* \Big) + \beta 
         \sum_{z \in \mathcal{Z} }  \Pi(z,z')
         \frac{ \partial^2 v^*\Big( z', x'(z,x; X^*) \Big)}{ \partial {x'}^2}
   \tag{d2vdc2}
\end{equation}
%%%
Hence, to compute how the policy changes given variations on other equilibrium quantities we can use
the \emph{Implicit function theorem} to get
%%%
\begin{equation}
   \label{eq:}
   \frac{ \partial x' \Big( z,x ; X^* \Big) }{ \partial X }  = - \frac{1}{ \text{d2vdc2} } \Big( \text{d2vdc2.der} \Big)
\end{equation}
%%%   



% Subsection how_to_do_the_perturbation_of_policy (end)
%..................................................................................................

\end{document}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% End document